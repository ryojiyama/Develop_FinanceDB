# 家計簿データベース構築プロジェクト記録

## 1. プロジェクト環境構築

### 基本構成
```
.
├── .DS_Store
├── .devcontainer
│   └── devcontainer.json
├── Docker
│   ├── Dockerfile
│   └── docker-compose.yml
├── SQLTables.numbers
├── data
│   ├── .DS_Store
│   ├── csv
│   │   ├── .DS_Store
│   │   ├── bank
│   │   └── card
│   └── processed
├── memo
│   ├── # 家計簿データベース設計書.md
│   ├── ChartWithClaude.md
│   ├── データベース構築記録_2025年1月1日.md
│   └── 家計簿データベース構造定義_2024年12月31日.md
├── readme.md
└── src
    ├── .DS_Store
    ├── create-staging-table.py
    ├── img
    │   ├── facebook_profile_image.png
    │   ├── linkedin_banner_image_1.png
    │   └── readme_banner.png
    ├── import_card_data.py
    ├── test_flet.py
    └── test_import_card_data.py
```

### 設定ファイル内容

**devcontainer.json**
```json
{
    "name": "Finance DB",
    "dockerComposeFile": ["../Docker/docker-compose.yml"],
    "service": "web",
    "workspaceFolder": "/workspace",
    "customizations": {
        "vscode": {
            "extensions": [
                "ms-python.python",
                "ms-azuretools.vscode-docker",
                "ms-toolsai.jupyter",
                "ms-toolsai.jupyter-keymap",
                "ms-toolsai.jupyter-renderers",
                "ms-python.black-formatter"
            ]
        }
    },
    "remoteUser": "root",
    "shutdownAction": "stopCompose"
}
```

**Dockerfile**
```dockerfile
FROM python:3
ENV PYTHONUNBUFFERED 1

# システムパッケージのインストール
RUN apt-get update \
    && apt-get install -y postgresql-client \
    && apt-get install -y nodejs npm \
    && rm -rf /var/lib/apt/lists/*

# Pythonパッケージのインストール
RUN pip install django psycopg2 pandas \
    # Jupyter関連パッケージ
    jupyterlab \
    ipykernel \
    # GUI開発用パッケージ
    flet \
    # データ可視化パッケージ
    matplotlib \
    seaborn \
    plotly \
    # 開発支援パッケージ
    black \
    flake8 \
    pytest

# Jupyter kernel の設定
RUN python -m ipykernel install --user --name=finance-kernel --display-name="Finance Project Python"

# 作業ディレクトリの設定
WORKDIR /workspace
```

## 2. データベース設計

### メインテーブル（transactions）
```sql
CREATE TABLE transactions (
    id SERIAL PRIMARY KEY,
    transaction_date DATE NOT NULL,             -- 取引日
    description TEXT NOT NULL,                  -- 取引内容
    withdrawal INTEGER,                         -- お引出し額
    deposit INTEGER,                            -- お預入れ額
    amount INTEGER,                             -- 金額（カード取引用）
    balance INTEGER,                            -- 残高
    account_id INTEGER REFERENCES accounts(id), -- 口座ID
    category_id INTEGER REFERENCES categories(id), -- カテゴリID
    transaction_type VARCHAR(20),               -- 取引種別
    is_regular BOOLEAN,                         -- 定期取引フラグ
    calculation_target BOOLEAN DEFAULT true,    -- 計算対象フラグ
    memo TEXT,                                  -- メモ
    source_file TEXT,                          -- データ元ファイル
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP
);
```

### カテゴリテーブル
```sql
CREATE TABLE categories (
    id SERIAL PRIMARY KEY,
    category_name VARCHAR(50) NOT NULL,
    is_expense BOOLEAN NOT NULL,    -- 支出カテゴリフラグ
    display_order INTEGER,          -- 表示順
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### 口座マスターテーブル
```sql
CREATE TABLE accounts (
    id SERIAL PRIMARY KEY,
    account_name VARCHAR(50) NOT NULL,
    account_type VARCHAR(20) NOT NULL, -- 銀行/クレジットカード
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### ステージングテーブル
```sql
-- 銀行取引ステージングテーブル
CREATE TABLE bank_staging (
    id SERIAL PRIMARY KEY,
    transaction_date DATE,           -- 年月日
    withdrawal INTEGER,              -- お引出し
    deposit INTEGER,                 -- お預入れ
    description TEXT,                -- お取り扱い内容
    balance INTEGER,                 -- 残高
    memo TEXT,                       -- メモ
    label TEXT,                      -- ラベル
    processed BOOLEAN DEFAULT false, -- 処理済みフラグ
    imported_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    error_message TEXT
);

-- カード取引ステージングテーブル
CREATE TABLE card_staging (
    id SERIAL PRIMARY KEY,
    transaction_date DATE,           -- 年月日
    description TEXT,                -- 内容
    amount INTEGER,                  -- 金額
    memo TEXT,                       -- メモ
    processed BOOLEAN DEFAULT false, -- 処理済みフラグ
    imported_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    error_message TEXT
);
```

## 3. データ取り込み処理

### CSVファイル構成
```
~/Dropbox/FinanceData/
├── bank_statements/    # 銀行取引CSVファイル
├── card_statements/    # カード取引CSVファイル
└── processed/         # 処理済みファイル
```

### CSVファイルフォーマット

**銀行取引明細**
- 年月日
- お引出し
- お預入れ
- お取り扱い内容
- 残高
- メモ
- ラベル(空欄)

**カード明細**
- 年月日
- 内容
- 金額
- メモ

### 処理フロー
1. CSVファイルの配置（手動）
2. データのクレンジング（自動）
   - 文字コードの統一
   - 日付形式の統一（YYYY-MM-DD）
   - 金額のフォーマット統一
3. ステージングテーブルへの取り込み
4. データ確認（GUI）
5. 本テーブルへの取り込み
6. 処理済みファイルの移動

### 定期取引パターン管理
```sql
CREATE TABLE regular_patterns (
    id SERIAL PRIMARY KEY,
    pattern_text TEXT NOT NULL,         -- マッチングパターン
    category_id INTEGER REFERENCES categories(id),
    is_regular BOOLEAN DEFAULT true,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

## 4. アプリケーション機能

### GUI機能（Flet）
- データ入力フォーム
- 取引履歴の表示
- カテゴリ別集計表示
- グラフ表示機能

### データ分析機能（Jupyter）
- 支出パターンの分析
- カテゴリ別の統計分析
- 予算と実績の比較

### 可視化機能
- matplotlib/seaborn: 静的グラフ生成
- plotly: インタラクティブな可視化

## 5. 将来の拡張性

[previous sections with budgets and sub_categories tables]

## 6. 開発環境の注意点
- Fletアプリケーション: 8550ポート
- JupyterLab: 8888ポート
- PostgreSQL: 5432ポート
- 作業ディレクトリ: `/workspace`
