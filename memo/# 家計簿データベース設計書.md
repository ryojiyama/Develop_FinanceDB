# 家計簿データベース設計書

## 1. データベース構造

### 1.1 メインテーブル（transactions）
```sql
CREATE TABLE transactions (
    id SERIAL PRIMARY KEY,
    transaction_date DATE NOT NULL,        -- 取引日
    description TEXT NOT NULL,             -- 取引内容
    withdrawal INTEGER,                    -- お引出し額
    deposit INTEGER,                       -- お預入れ額
    amount INTEGER,                        -- 金額（カード取引用）
    balance INTEGER,                       -- 残高
    account_id INTEGER REFERENCES accounts(id), -- 口座ID
    category_id INTEGER REFERENCES categories(id), -- カテゴリID
    transaction_type VARCHAR(20),          -- 取引種別
    is_regular BOOLEAN,                    -- 定期取引フラグ
    calculation_target BOOLEAN DEFAULT true, -- 計算対象フラグ
    memo TEXT,                            -- メモ
    source_file TEXT,                     -- データ元ファイル
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP
);
```

### 1.2 カテゴリマスター（categories）
```sql
CREATE TABLE categories (
    id SERIAL PRIMARY KEY,
    category_name VARCHAR(50) NOT NULL,
    is_expense BOOLEAN NOT NULL,    -- 支出カテゴリフラグ
    display_order INTEGER,          -- 表示順
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### 1.3 口座マスター（accounts）
```sql
CREATE TABLE accounts (
    id SERIAL PRIMARY KEY,
    account_name VARCHAR(50) NOT NULL,
    account_type VARCHAR(20) NOT NULL, -- 銀行/クレジットカード
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```
### 1.4 銀行取引ステージングテーブル（bank_staging）
```sql
    CREATE TABLE IF NOT EXISTS bank_staging (
        id SERIAL PRIMARY KEY,
        transaction_date DATE,           -- 年月日
        withdrawal INTEGER,              -- お引出し
        deposit INTEGER,                 -- お預入れ
        description TEXT,                -- お取り扱い内容
        balance INTEGER,                 -- 残高
        memo TEXT,                       -- メモ
        label TEXT,                      -- ラベル
        processed BOOLEAN DEFAULT false, -- 処理済みフラグ
        imported_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        error_message TEXT
    );
```
### 1.4 カード取引ステージングテーブル（card_staging）
```sql
    CREATE TABLE IF NOT EXISTS card_staging (
        id SERIAL PRIMARY KEY,
        transaction_date DATE,           -- 年月日
        description TEXT,                -- 内容
        amount INTEGER,                  -- 金額
        memo TEXT,                       -- メモ
        processed BOOLEAN DEFAULT false, -- 処理済みフラグ
        imported_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        error_message TEXT
    );
```

## 2. データ取り込みプロセス

### 2.1 ファイル構成
```
~/Dropbox/FinanceData/
├── bank_statements/    # 銀行の新規CSVファイル用
├── card_statements/    # カードの新規CSVファイル用
└── processed/         # 処理済みファイル用
```

### 2.2 処理フロー
1. 明細のダウンロード（手動）
   - カード会社のWebサイトから明細をダウンロード

2. ファイルの配置（手動）
   - ダウンロードした明細を `~/Dropbox/FinanceData/card_statements/` or /bank_statements/に配置

3. データクレンジング（自動）
   - ファイル監視プログラムが新規ファイルを検知
   - 日付形式の統一（YYYY-MM-DD）
   - 全角文字の半角化
   - 金額の正規化
   - 返品データの処理
   - 参照番号の抽出

4. データ確認（半自動）
   - クレンジング結果をGUIで表示
   - データプレビューの確認
   - インポート承認または取り消し

5. データベースへのインポート（自動）
   - 承認後、自動的にステージングテーブルへインポート
   - 処理済みファイルの移動

## 3. 運用ルール

### 3.1 ファイル管理
- 原本CSVは `card_statements` フォルダに配置
- 処理済みファイルは自動的に `processed` フォルダへ移動
- ファイル名に処理日時を付与して保存

### 3.2 データ検証
- インポート前に必ずGUIで確認
- 異常データはエラーメッセージを記録
- 処理結果はログに記録

### 3.3 バックアップ
- Dropboxによる自動バックアップ
- データベースの定期バックアップ（別途設定）

## 4. 拡張予定機能

### 4.1 予算管理
```sql
CREATE TABLE budgets (
    id SERIAL PRIMARY KEY,
    category_id INTEGER REFERENCES categories(id),
    year_month DATE,
    amount INTEGER,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### 4.2 中項目管理
```sql
CREATE TABLE sub_categories (
    id SERIAL PRIMARY KEY,
    main_category_id INTEGER REFERENCES categories(id),
    sub_category_name VARCHAR(50) NOT NULL,
    display_order INTEGER,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(main_category_id, sub_category_name)
);
```

## 5. 定期メンテナンス

### 5.1 データクレンジングルールの更新
- 新しい取引パターンの追加
- カテゴリ判定ルールの調整
- エラーパターンの分析と対応

### 5.2 性能最適化
- インデックスの見直し
- 古いデータのアーカイブ
- ステージングテーブルのクリーンアップ


.
├── .DS_Store
├── .devcontainer
│   └── devcontainer.json
├── Docker
│   ├── Dockerfile
│   └── docker-compose.yml
├── SQLTables.numbers
├── data
│   ├── .DS_Store
│   ├── csv
│   │   ├── .DS_Store
│   │   ├── bank
│   │   └── card
│   └── processed
├── memo
│   ├── # 家計簿データベース設計書.md
│   ├── ChartWithClaude.md
│   ├── データベース構築記録_2025年1月1日.md
│   └── 家計簿データベース構造定義_2024年12月31日.md
├── readme.md
└── src
    ├── .DS_Store
    ├── create-staging-table.py
    ├── img
    │   ├── facebook_profile_image.png
    │   ├── linkedin_banner_image_1.png
    │   └── readme_banner.png
    ├── import_card_data.py
    ├── test_flet.py
    └── test_import_card_data.py
